// -- Sammy -- /plugins/sammy.handlebars.js
// http://code.quirkey.com/sammy
// Version: 0.6.2
// Built: Mon Oct 11 12:41:43 -0700 2010
(function(b){var c={compilerCache:{},compile:function(d){if(c.compilerCache[d]==null){var f=c.compileFunctionBody(d);var e=new Function("context","fallback","Handlebars",f);c.compilerCache[d]=function(g,h){return e(g,h,c)}}return c.compilerCache[d]},compileToString:function(d){var e=c.compileFunctionBody(d);return"function(context, fallback) { "+e+"}"},compileFunctionBody:function(d){var e=new c.Compiler(d);e.compile();return"fallback = fallback || {}; var stack = [];"+e.fn},isFunction:function(d){return Object.prototype.toString.call(d)=="[object Function]"},trim:function(d){return d.replace(/^\s+|\s+$/g,"")},escapeText:function(d){d=d.replace(/'/g,"\\'");d=d.replace(/\"/g,'\\"');return d},escapeExpression:function(d){if(d instanceof c.SafeString){return d.toString()}else{if(d===null){d=""}}return d.toString().replace(/&(?!\w+;)|["\\<>]/g,function(e){switch(e){case"&":return"&amp;";break;case'"':return'"';case"\\":return"\\\\";break;case"<":return"&lt;";break;case">":return"&gt;";break;default:return e}})},compilePartial:function(d){if(c.isFunction(d)){compiled=d}else{compiled=c.compile(d)}return compiled},evalExpression:function(h,f,d){var k=c.parsePath(h);var j=k[0];var g=k[1];if(j>d.length){f=null}else{if(j>0){f=d[d.length-j]}}for(var e=0;e<g.length&&f!==undefined;e++){f=f[g[e]]}return f},buildContext:function(f,d){var e=function(g){this.__stack__=g.slice(0);this.__get__=function(h){return c.evalExpression(h,this,this.__stack__)}};e.prototype=f;return new e(d)},pathPatterns:{},parsePath:function(k){if(k==null){return[0,[]]}else{if(c.pathPatterns[k]!=null){return c.pathPatterns[k]}}var h=k.split("/");var m=false;var l=0;var f=[];for(var g=0,e=h.length;g<e;g++){switch(h[g]){case"..":if(m){throw new c.Exception("Cannot jump out of context after moving into a context.")}else{l+=1}break;case".":case"this":break;default:m=true;f.push(h[g])}}var d=[l,f];c.pathPatterns[k]=d;return d},isEmpty:function(d){if(typeof d==="undefined"){return true}else{if(!d){return true}else{if(Object.prototype.toString.call(d)==="[object Array]"&&d.length==0){return true}else{return false}}}},filterOutput:function(e,d){if(c.isEmpty(e)){return""}else{if(d){return c.escapeExpression(e)}else{return e}}},handleBlock:function(i,g,d,h,e){var f="";if(c.isFunction(i)){f=f+i.call(g,d,h);if(e!=null&&c.isFunction(i.not)){f=f+i.not.call(g,d,e)}}else{if(!c.isEmpty(i)){f=f+c.helperMissing.call(d,i,h)}if(e!=null){f=f+c.helperMissing.not.call(d,i,e)}}return f},handleExpression:function(h,g,d,e){var f="";if(c.isFunction(h)){f=f+c.filterOutput(h.call(g,d),e)}else{if(!c.isEmpty(h)){f=f+c.filterOutput(h,e)}}return f},handleInvertedSection:function(g,e,f){var d="";if(c.isFunction(g)&&c.isEmpty(g())){d=d+f(e)}else{if(c.isEmpty(g)){d=d+f(e)}}return d}};c.Compiler=function(d){this.string=d;this.pointer=-1;this.mustache=false;this.text="";this.fn="var out = ''; var lookup; ";this.newlines="";this.comment=false;this.escaped=true;this.partial=false;this.inverted=false;this.endCondition=null;this.continueInverted=false};c.Exception=function(d){this.message=d};c.SafeString=function(d){this.string=d};c.SafeString.prototype.toString=function(){return this.string.toString()};c.helperMissing=function(f,h){var e="";if(f===true){return h(this)}else{if(f===false){return""}else{if(Object.prototype.toString.call(f)==="[object Array]"){for(var g=0,d=f.length;g<d;g++){e=e+h(f[g])}return e}else{return h(f)}}}};c.helperMissing.not=function(d,e){return e(d)};c.Compiler.prototype={getChar:function(e){var d=this.peek(e);this.pointer=this.pointer+(e||1);return d},peek:function(e){e=e||1;var d=this.pointer+1;return this.string.slice(d,d+e)},compile:function(e){if(!e||!e(this)){var d;while(d=this.getChar()){if(d==="{"&&this.peek()==="{"&&!this.mustache){this.getChar();this.parseMustache()}else{if(d==="\n"){this.newlines=this.newlines+"\n";d="\\n"}else{if(d==="\r"){this.newlines=this.newlines+"\r";d="\\r"}else{if(d==="\\"){d="\\\\"}}}this.text=this.text+d}if(e&&this.peek(5)=="{{^}}"){this.continueInverted=true;this.getChar(5);break}else{if(e&&e(this)){break}}}}this.addText();this.fn+="return out;";return},addText:function(){if(this.text){this.fn=this.fn+'out = out + "'+c.escapeText(this.text)+'"; ';this.fn=this.fn+this.newlines;this.newlines="";this.text=""}},addExpression:function(d,f){f=f||null;var e=this.lookupFor(d);this.fn+="var proxy = Handlebars.buildContext(context, stack);";this.fn+="out = out + Handlebars.handleExpression("+e+", proxy, "+f+", "+this.escaped+");"},addInvertedSection:function(g){var f=this.compileToEndOfBlock(g);var d=f.fn;var e="fn"+this.pointer.toString();this.fn+="var "+e+" = function(context) {"+d+"}; ";this.fn+="lookup = "+this.lookupFor(g)+"; ";this.fn+="out = out + Handlebars.handleInvertedSection(lookup, context, "+e+");";this.openBlock=false;this.inverted=false},lookupFor:function(g){var d=c.parsePath(g);var f=d[0];var e=d[1];if(f>0||e.length>1){return"(Handlebars.evalExpression('"+g+"', context, stack))"}else{if(e.length==1){return"(context['"+e[0]+"'] || fallback['"+e[0]+"'])"}else{return"(context || fallback)"}}},compileToEndOfBlock:function(e){var d=new c.Compiler(this.string.slice(this.pointer+1));d.compile(function(f){if(f.peek(3)==="{{/"){if(f.peek(e.length+5)==="{{/"+e+"}}"){f.getChar(e.length+5);return true}else{throw new c.Exception("Mismatched block close: expected "+e+".")}}});this.pointer+=d.pointer+1;return d},addBlock:function(h,j,i){var g=this.compileToEndOfBlock(h);var d=g.fn;var f="fn"+this.pointer.toString();this.fn+="var wrappedContext = Handlebars.buildContext(context, stack);";this.fn+="stack.push(context);";this.fn+="var "+f+" = function(context) {"+d+"}; ";this.fn+="lookup = "+this.lookupFor(h)+"; ";if(g.continueInverted){var e=this.compileToEndOfBlock(h);this.fn+=" var "+f+"Not = function(context) { "+e.fn+" };"}else{this.fn+=" var "+f+"Not = null;"}this.fn+="out = out + Handlebars.handleBlock(lookup, wrappedContext, "+j+", "+f+", "+f+"Not);";this.fn+="stack.pop();";this.openBlock=false},addPartial:function(d,e){this.fn+="if (typeof fallback['partials'] === 'undefined' || typeof fallback['partials']['"+d+"'] === 'undefined') throw new Handlebars.Exception('Attempted to render undefined partial: "+d+"');";this.fn+="out = out + Handlebars.compilePartial(fallback['partials']['"+d+"'])("+e+", fallback);"},parseMustache:function(){var f,d,g,i;var e=this.peek();if(e==="!"){this.comment=true;this.getChar()}else{if(e==="#"){this.openBlock=true;this.getChar()}else{if(e===">"){this.partial=true;this.getChar()}else{if(e==="^"){this.inverted=true;this.openBlock=true;this.getChar()}else{if(e==="{"||e==="&"){this.escaped=false;this.getChar()}}}}}this.addText();this.mustache=" ";while(f=this.getChar()){if(this.mustache&&f==="}"&&this.peek()==="}"){var h=c.trim(this.mustache).split(/\s+/);g=h[0];i=this.lookupFor(h[1]);this.mustache=false;this.getChar();if(!this.escaped&&this.peek()==="}"){this.getChar()}if(this.comment){this.comment=false;return}else{if(this.partial){this.addPartial(g,i);this.partial=false;return}else{if(this.inverted){this.addInvertedSection(g);this.inverted=false;return}else{if(this.openBlock){this.addBlock(g,i,h);return}else{return this.addExpression(g,i)}}}}this.escaped=true}else{if(this.comment){}else{this.mustache=this.mustache+f}}}}};var a=a||{};a.compile=c.compile;a.compileToString=c.compileToString;Sammy=Sammy||{};Sammy.Handlebars=function(g,e){var f={};var d=function(k,l,i,h){if(typeof h=="undefined"){h=k}var j=f[h];if(!j){j=f[h]=c.compile(k)}l=b.extend({},this,l);i=b.extend({},l.partials,i);return j(l,{partials:i})};if(!e){e="handlebars"}g.helper(e,d)}})(jQuery);